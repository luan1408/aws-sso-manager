#!/bin/bash
# AWS SSO Manager - Vers√£o Ultra Simplificada
# S√≥ o que realmente importa!

cd "$(dirname "$0")"

# Fun√ß√£o auxiliar para persist√™ncia
_get_current_profile() {
    if [ -f ~/.aws/current_profile ]; then
        cat ~/.aws/current_profile 2>/dev/null
    else
        echo "default"
    fi
}

# Salva perfil atual
_save_profile() {
    mkdir -p ~/.aws
    echo "$1" > ~/.aws/current_profile
    export AWS_PROFILE="$1"
}

# Lista perfis com interface bonita
_list_profiles() {
    clear
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë                   üìã PERFIS AWS DISPON√çVEIS              ‚ïë"
    echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"
    
    local current=$(_get_current_profile)
    local count=0
    
    aws configure list-profiles 2>/dev/null | while read profile; do
        if [ "$profile" = "$current" ]; then
            echo "‚ïë  ‚û§ $profile (perfil atual)"
        else
            echo "‚ïë    $profile"
        fi
        count=$((count + 1))
    done
    
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
}

# Seletor visual de perfis  
_select_profile_visual() {
    while true; do
        clear
        echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
        echo "‚ïë              üîÑ SELE√á√ÉO VISUAL DE PERFIS                ‚ïë"
        echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
        echo ""
        
        local current_profile=$(_get_current_profile)
        local profiles=($(aws configure list-profiles 2>/dev/null))
        local count=1
        
        echo "üìã Selecione o perfil desejado:"
        echo ""
        
        # Lista perfis numerados
        for profile in "${profiles[@]}"; do
            if [ "$profile" = "$current_profile" ]; then
                echo "  $count) ‚û§ $profile (atual)"
            else
                echo "  $count)   $profile"
            fi
            count=$((count + 1))
        done
        
        echo ""
        echo "  0) ‚¨ÖÔ∏è  Voltar ao menu principal"
        echo ""
        
        read -p "üìå Digite o n√∫mero do perfil [0-$((count-1))]: " choice
        
        # Valida escolha
        if [ "$choice" = "0" ]; then
            break
        elif [ "$choice" -gt 0 ] && [ "$choice" -lt "$count" ] 2>/dev/null; then
            local selected_profile=${profiles[$((choice-1))]}
            
            clear
            echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
            echo "‚ïë                    üîÑ ALTERANDO PERFIL                  ‚ïë"
            echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
            echo ""
            echo "üîÑ Alterando para: $selected_profile"
            echo ""
            
            _save_profile "$selected_profile"
            echo "‚úÖ Perfil alterado com sucesso!"
            
            # Verifica credenciais
            echo "üîç Verificando credenciais..."
            if aws sts get-caller-identity --output table 2>/dev/null; then
                echo ""
                echo "üîë Credenciais v√°lidas!"
            else
                echo ""
                echo "‚ö†Ô∏è  Credenciais expiradas ou inv√°lidas"
                echo "üí° Execute: aws sso login --profile $selected_profile"
            fi
            
            echo ""
            read -p "Pressione Enter para voltar ao menu..."
            break
        else
            echo ""
            echo "‚ùå Op√ß√£o inv√°lida! Digite um n√∫mero entre 0 e $((count-1))"
            sleep 2
        fi
    done
}

# Menu principal bonito
_main_menu() {
    while true; do
        clear
        echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
        echo "‚ïë                    üöÄ AWS SSO Manager                   ‚ïë"
        echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"
        echo "‚ïë                                                          ‚ïë"
        echo "‚ïë  üìã Perfil atual: $(_get_current_profile)"
        echo "‚ïë                                                          ‚ïë"
        echo "‚ïë  1) üìã Listar todos os perfis                           ‚ïë"
        echo "‚ïë  2) üîÑ Selecionar perfil (Interface visual)             ‚ïë" 
        echo "‚ïë  3) üîê Fazer login SSO                                  ‚ïë"
        echo "‚ïë  4) üë§ Ver status e credenciais                         ‚ïë"
        echo "‚ïë  5) üö™ Sair                                             ‚ïë"
        echo "‚ïë                                                          ‚ïë"
        echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
        echo ""
        read -p "üìå Escolha uma op√ß√£o [1-5]: " choice
        
        case $choice in
            1)
                _list_profiles
                read -p "Pressione Enter..."
                ;;
            2)
                _select_profile_visual
                ;;
            3)
                clear
                echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
                echo "‚ïë                      üîê LOGIN SSO                       ‚ïë"
                echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
                echo ""
                
                # Mostra perfis dispon√≠veis
                echo "üìã Perfis dispon√≠veis:"
                echo ""
                local profiles=($(aws configure list-profiles 2>/dev/null))
                local count=1
                for profile in "${profiles[@]}"; do
                    echo "  $count) $profile"
                    count=$((count + 1))
                done
                echo ""
                
                read -p "üíª Digite o n√∫mero ou nome do perfil para login: " input
                if [ -n "$input" ]; then
                    # Verifica se √© um n√∫mero
                    if [[ "$input" =~ ^[0-9]+$ ]]; then
                        # Converte n√∫mero para nome do perfil
                        if [ "$input" -gt 0 ] && [ "$input" -lt "$count" ]; then
                            profile=${profiles[$((input-1))]}
                            echo "üìã Perfil selecionado: $profile"
                        else
                            echo "‚ùå N√∫mero inv√°lido! Digite entre 1 e $((count-1))"
                            profile=""
                        fi
                    else
                        # Usa o nome diretamente
                        profile="$input"
                    fi
                    
                    if [ -n "$profile" ] && aws configure list-profiles 2>/dev/null | grep -q "^${profile}$"; then
                        echo ""
                        echo "üîê Fazendo login SSO no perfil: $profile"
                        echo ""
                        echo "üí° INSTRU√á√ïES PARA WSL/Linux:"
                        echo "   1. O navegador pode n√£o abrir automaticamente"
                        echo "   2. Copie a URL que aparecer abaixo"
                        echo "   3. Cole no seu navegador (Chrome/Firefox/Edge)"
                        echo "   4. Use o c√≥digo de autoriza√ß√£o mostrado"
                        echo "   5. WSL: Voc√™ pode usar 'cmd.exe /c start URL' para abrir no Windows"
                        echo ""
                        echo "üöÄ Iniciando login SSO..."
                        echo ""
                        
                        # Captura erros do xdg-open mas continua o processo
                        aws sso login --profile "$profile" 2>/dev/null || aws sso login --profile "$profile"
                        
                        if [ $? -eq 0 ]; then
                            _save_profile "$profile"
                            echo ""
                            echo "‚úÖ Login realizado com sucesso!"
                            echo "üìã Perfil alterado para: $profile"
                            echo "üîë Credenciais SSO configuradas!"
                        else
                            echo ""
                            echo "‚ùå Falha no login SSO"
                            echo "üí° Dicas:"
                            echo "   - Verifique se copiou a URL corretamente"
                            echo "   - Confirme se usou o c√≥digo correto"
                            echo "   - Tente novamente se necess√°rio"
                        fi
                    else
                        echo ""
                        echo "‚ùå Perfil '$profile' n√£o encontrado"
                        echo "üí° Use o n√∫mero (ex: 2) ou nome completo (ex: wiipo-prod)"
                    fi
                else
                    echo ""
                    echo "‚ùå Nada foi digitado!"
                    echo "üí° Digite o n√∫mero ou nome do perfil"
                fi
                echo ""
                read -p "Pressione Enter para voltar ao menu..."
                ;;
            4)
                clear
                echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
                echo "‚ïë                 üë§ STATUS E CREDENCIAIS                 ‚ïë"
                echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
                echo ""
                echo "üìã Perfil atual: $(_get_current_profile)"
                echo ""
                echo "üîç Verificando credenciais..."
                echo ""
                if aws sts get-caller-identity --output table 2>/dev/null; then
                    echo ""
                    echo "‚úÖ Credenciais v√°lidas e ativas!"
                else
                    echo "‚ùå Credenciais inv√°lidas ou expiradas"
                    echo ""
                    echo "üí° Para fazer login:"
                    echo "   aws sso login --profile $(_get_current_profile)"
                fi
                echo ""
                read -p "Pressione Enter para voltar ao menu..."
                ;;
            5)
                clear
                echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
                echo "‚ïë                        üëã SAINDO                        ‚ïë"
                echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
                echo ""
                echo "‚úÖ Perfil atual salvo: $(_get_current_profile)"
                echo ""
                echo "üí° Para usar novamente: ./aws-simple.sh"
                echo ""
                echo "üëã Obrigado por usar o AWS SSO Manager!"
                echo ""
                exit 0
                ;;
            *)
                clear
                echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
                echo "‚ïë                      ‚ùå OP√á√ÉO INV√ÅLIDA                   ‚ïë"
                echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
                echo ""
                echo "‚ö†Ô∏è  Op√ß√£o '$choice' n√£o √© v√°lida"
                echo ""
                echo "üí° Escolha um n√∫mero entre 1 e 5"
                echo ""
                read -p "Pressione Enter para continuar..."
                ;;
        esac
    done
}

# Comandos diretos
case "$1" in
    "list")
        _list_profiles
        ;;
    "switch")
        if [ -z "$2" ]; then
            echo "Uso: $0 switch <perfil>"
            _list_profiles
        else
            _save_profile "$2"
            echo "‚úÖ Perfil alterado para: $2"
        fi
        ;;
    "menu"|"")
        _main_menu
        ;;
    *)
        echo "üöÄ AWS SSO Manager - Ultra Simples"
        echo ""
        echo "Uso:"
        echo "  $0          - Menu interativo"
        echo "  $0 menu     - Menu interativo"  
        echo "  $0 list     - Lista perfis"
        echo "  $0 switch <perfil> - Troca perfil"
        echo ""
        echo "Exemplo: $0 switch wiipo-prod"
        ;;
esac